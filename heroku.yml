setup:
  addons:
    - plan: heroku-postgresql:standard-0
build:
  docker:
    web: Dockerfile
release:
  command:
    - ./scripts.deploy/release.sh
  image: web
run:
  web: >
    sops -d -i secrets/config.${PANGEO_FORGE_DEPLOYMENT}.yaml
    && export DATAFLOW_CREDS='./secrets/dataflow-job-submission.json'
    && sops -d -i ${DATAFLOW_CREDS}
    && gcloud auth activate-service-account --key-file=${DATAFLOW_CREDS}
    && cat ${DATAFLOW_CREDS}
    | python3.9 -c "import sys, json; print(json.load(sys.stdin)['project_id'].strip())"
    | xargs -I{} gcloud config set project {}
    && export GOOGLE_APPLICATION_CREDENTIALS=${DATAFLOW_CREDS}
    && export BAKERY_SECRETS='./secrets/bakery-args.pangeo-ldeo-nsf-earthcube.yaml'
    && sops -d -i ${BAKERY_SECRETS}
    && gunicorn -w 3 -t 300 -k uvicorn.workers.UvicornWorker pangeo_forge_orchestrator.api:app
